<section class="page">
  <h2 class="page__title">{{ titleKey | t }}</h2>
  @if (flashMsg) {
    <div class="flash success" role="status" aria-live="polite">{{ flashMsg }}</div>
  }
  @if (error) {
    <div class="error">{{ 'communications.errorLoading' | t }}</div>
  }

  @if (loading) {
    <div class="loading">
      <span class="spinner" role="status" [attr.aria-label]="'charts.loading' | t"></span>
    </div>
  } @else {
    <div class="table-toolbar" *ngIf="clienti.length > 0">
      <div class="toolbar-left">
        <div class="search">
          <i class="pi pi-search"></i>
          <input [(ngModel)]="q" name="q" [placeholder]="'common.search' | t" (keyup.enter)="applyFilter()" />
        </div>
      </div>
      <div class="toolbar-right">
        <button type="button" class="icon-btn" [title]="'common.new' | t" (click)="toggleAddMenu()"><i class="pi pi-plus"></i></button>
        <button type="button" class="icon-btn" [title]="'common.filters' | t" (click)="toggleFilters()"><i class="pi pi-filter"></i></button>
        <button type="button" class="icon-btn" [title]="'common.refresh' | t" (click)="refresh()"><i class="pi pi-refresh"></i></button>
        <button type="button" class="icon-btn" [disabled]="exporting" title="Export CSV" (click)="openExportConfirm()"><i class="pi pi-download"></i></button>
        <span class="page-indicator">{{ page }} {{ 'common.of' | t }} {{ hasTotal ? totalPages : '?' }}</span>
        <button type="button" class="icon-btn" [title]="'common.prev' | t" (click)="prevPage()" [disabled]="page===1"><i class="pi pi-angle-left"></i></button>
        <button type="button" class="icon-btn" [title]="'common.next' | t" (click)="nextPage()" [disabled]="!hasNext"><i class="pi pi-angle-right"></i></button>

        <!-- Hidden CSV input always present to avoid destruction during menu toggling -->
        <input #csvInput type="file" accept=".csv,text/csv" (change)="onCsvSelected($event)" style="display:none" />

        @if (showAddMenu) {
          <div class="filter-menu" (click)="$event.stopPropagation()">
            <button class="submenu-btn" type="button" (click)="openCreate(); toggleAddMenu(false)">
              <i class="pi pi-file-plus"></i>
              <span style="margin-left:8px">{{ 'clients.addRecord' | t }}</span>
            </button>
            <button class="submenu-btn" type="button" (click)="openImportPrompt()">
              <i class="pi pi-upload"></i>
              <span style="margin-left:8px">{{ 'clients.importCsv' | t }}</span>
            </button>
          </div>
        }

        @if (showFilters) {
          <div class="filter-menu" (click)="$event.stopPropagation()">
            @if (filtersLoading) {
              <div class="loading"><span class="spinner" role="status" aria-label="Loading"></span></div>
            } @else if (filtersError) {
              <div class="error">{{ 'filters.errorLoading' | t }}</div>
            } @else {
            <!-- Cities submenu -->
            <button class="submenu-btn" type="button" (click)="toggleSection('city')">
              <span>{{ 'filters.cities' | t }}</span>
              <i class="pi" [ngClass]="openCities ? 'pi-angle-down' : 'pi-angle-right'"></i>
            </button>
            <div class="submenu-panel" [class.open]="openCities">
              <input class="mini-search" [(ngModel)]="cityFilter" [placeholder]="'filters.searchCity' | t" />
              <div class="options">
                @for (opt of filterList(distinctCities, cityFilter); track opt) {
                  <label><input type="checkbox" [checked]="isChecked('city', opt)" (change)="toggleOption('city', opt, $event)" /> {{ opt }}</label>
                }
              </div>
            </div>

            <!-- Categories submenu -->
            <button class="submenu-btn" type="button" (click)="toggleSection('category')">
              <span>{{ 'filters.categories' | t }}</span>
              <i class="pi" [ngClass]="openCategories ? 'pi-angle-down' : 'pi-angle-right'"></i>
            </button>
            <div class="submenu-panel" [class.open]="openCategories">
              <input class="mini-search" [(ngModel)]="categoryFilter" [placeholder]="'filters.searchCategory' | t" />
              <div class="options">
                @for (opt of filterList(distinctCategories, categoryFilter); track opt) {
                  <label><input type="checkbox" [checked]="isChecked('category', opt)" (change)="toggleOption('category', opt, $event)" /> {{ opt }}</label>
                }
              </div>
            </div>

            <!-- Status submenu -->
            <button class="submenu-btn" type="button" (click)="toggleSection('status')">
              <span>{{ 'filters.status' | t }}</span>
              <i class="pi" [ngClass]="openStatuses ? 'pi-angle-down' : 'pi-angle-right'"></i>
            </button>
            <div class="submenu-panel" [class.open]="openStatuses">
              <input class="mini-search" [(ngModel)]="statusFilter" [placeholder]="'filters.searchStatus' | t" />
              <div class="options">
                @for (opt of filterList(distinctStatuses, statusFilter); track opt) {
                  <label><input type="checkbox" [checked]="isChecked('status', opt)" (change)="toggleOption('status', opt, $event)" /> {{ opt }}</label>
                }
              </div>
            </div>

            <div class="filters-actions">
              <button type="button" class="btn ghost" (click)="clearAllFilters()">{{ 'filters.clear' | t }}</button>
              <button type="button" class="btn primary" (click)="applyFilters()">{{ 'filters.apply' | t }}</button>
            </div>
            }
          </div>
        }
      </div>
  </div>
    @if (exporting) {
      <div class="overlay"></div>
      <div class="detail-card" role="dialog" aria-modal="true" aria-label="Export CSV">
        <div class="card" (click)="$event.stopPropagation()" style="max-width: 520px; width: 100%">
          <header class="card-header">
            <h3 class="card-title">Esportazione CSV</h3>
          </header>
          <div class="card-body">
            <div class="export-status">
              <div class="row">
                <span class="lbl">Stato:</span>
                <span class="val">{{ exportPhase === 'preparing' ? 'Preparazione' : exportPhase === 'fetching' ? 'Raccolta dati' : exportPhase === 'building' ? 'Creazione file' : exportPhase === 'downloading' ? 'Download' : '...' }}</span>
              </div>
              <div class="row" *ngIf="exportTotal > 0">
                <span class="lbl">Progresso:</span>
                <span class="val">{{ exportDone }} / {{ exportTotal }} ({{ (exportDone / exportTotal) | percent:'1.0-0' }})</span>
              </div>
              <div class="progress" *ngIf="exportTotal > 0">
                <div class="bar" [style.width.%]="(exportDone / exportTotal) * 100"></div>
              </div>
              <div class="loading" *ngIf="exportTotal === 0"><span class="spinner" role="status"></span></div>
            </div>
          </div>
        </div>
      </div>
    }
    @if (showExportConfirm) {
      <div class="overlay"></div>
      <div class="detail-card" role="dialog" aria-modal="true" aria-label="Conferma export">
        <div class="card" (click)="$event.stopPropagation()" style="max-width: 520px; width: 100%">
          <header class="card-header">
            <h3 class="card-title">Confermi l'esportazione?</h3>
            <button type="button" class="btn-close" (click)="cancelExportConfirm()" aria-label="Chiudi"><i class="pi pi-times"></i></button>
          </header>
          <div class="card-body">
            <p>Verranno scaricati <b>{{ exportCount }}</b> record in formato CSV secondo i filtri correnti.</p>
            <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
              <button type="button" class="btn ghost" (click)="cancelExportConfirm()">Annulla</button>
              <button type="button" class="btn primary" (click)="proceedExportConfirm()">Esporta</button>
            </div>
          </div>
        </div>
      </div>
    }
    @if (clienti.length === 0) {
      <div class="empty-state comm">
        <div class="empty-card">
          <div class="empty-icon"><i class="pi pi-comments"></i></div>
          <div class="empty-title">{{ 'communications.empty' | t }}</div>
          <div class="empty-sub">Aggiungi un contatto o importa un CSV.</div>
          <div class="empty-actions">
            <button type="button" class="btn primary big" (click)="openCreate()">
              <i class="pi pi-plus"></i>
              <span>{{ 'common.new' | t }}</span>
            </button>
            <button type="button" class="btn outline big" (click)="openImportPrompt()">
              <i class="pi pi-upload"></i>
              <span>{{ 'clients.importCsv' | t }}</span>
            </button>
          </div>
        </div>
      </div>
    } @else {
      <div class="table-container">
        <table class="clients-table" aria-label="{{ 'communications.title' | t }}">
          <colgroup>
            <col style="width:28%" /> <!-- Nome -->
            <col style="width:16%" /> <!-- Città -->
            <col style="width:16%" /> <!-- Categoria -->
            <col style="width:20%" /> <!-- Assegnato -->
            <col style="width:12%" /> <!-- Stato -->
            <col style="width:96px" /> <!-- Azioni (link + lente) -->
          </colgroup>
          <thead>
            <tr>
              <th scope="col" class="sortable" (click)="setSort('name')">
                {{ 'communications.table.name' | t }}
                <i class="pi" [ngClass]="sortBy==='name' ? (sortDir==='asc' ? 'pi-sort-alpha-down' : 'pi-sort-alpha-up') : 'pi-sort-alt'"></i>
              </th>
              <th scope="col" class="sortable" (click)="setSort('city')">
                {{ 'communications.table.city' | t }}
                <i class="pi" [ngClass]="sortBy==='city' ? (sortDir==='asc' ? 'pi-sort-alpha-down' : 'pi-sort-alpha-up') : 'pi-sort-alt'"></i>
              </th>
              <th scope="col" class="sortable" (click)="setSort('category')">
                {{ 'communications.table.category' | t }}
                <i class="pi" [ngClass]="sortBy==='category' ? (sortDir==='asc' ? 'pi-sort-alpha-down' : 'pi-sort-alpha-up') : 'pi-sort-alt'"></i>
              </th>
              <th scope="col" class="sortable" (click)="setSort('assign')">
                {{ 'communications.table.assigned' | t }}
                <i class="pi" [ngClass]="sortBy==='assign' ? (sortDir==='asc' ? 'pi-sort-alpha-down' : 'pi-sort-alpha-up') : 'pi-sort-alt'"></i>
              </th>
              <th scope="col" class="sortable" (click)="setSort('status')">
                {{ 'communications.table.status' | t }}
                <i class="pi" [ngClass]="sortBy==='status' ? (sortDir==='asc' ? 'pi-sort-alpha-down' : 'pi-sort-alpha-up') : 'pi-sort-alt'"></i>
              </th>
              <th scope="col" class="col-actions" aria-label="Azioni">More</th>
            </tr>
          </thead>
          <tbody>
        @for (c of clienti; track c.id) {
          <tr>
            <td class="name-cell"><span class="name">{{ c.nome }}</span></td>
            <td>{{ c.citta }}</td>
            <td>{{ c.categoria }}</td>
            <td>{{ assignedDisplay(c.assegnato) }}</td>
            <td>
              <span class="stato" [ngClass]="statusClass(c.stato)">{{ c.stato }}</span>
            </td>
            <td class="col-actions has-menu">
              <button type="button" class="circle-btn" (click)="toggleRowMenu(c.id, $event); $event.stopPropagation()" title="Azioni" aria-label="Azioni">
                <i class="pi pi-ellipsis-v"></i>
              </button>
              @if (openRowMenuId === c.id) {
                <div class="row-menu" [class.up]="rowMenuUp" (click)="$event.stopPropagation()">
                  @if (siteHref(c.site)) {
                    <button class="row-menu__item" type="button" (click)="openSiteFromRow(c)"><i class="pi pi-external-link"></i><span>Apri URL</span></button>
                  }
                  <button class="row-menu__item" type="button" (click)="exportCsvRow(c)"><i class="pi pi-download"></i><span>Esporta CSV</span></button>
                  <button class="row-menu__item" type="button" (click)="openDetails(c)"><i class="pi pi-pencil"></i><span>Modifica dettagli</span></button>
                  <button class="row-menu__item danger" type="button" (click)="deleteRow(c)"><i class="pi pi-trash"></i><span>Elimina riga</span></button>
                </div>
              }
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
    }
  }

  @if (showImportPrompt) {
    <div class="overlay"></div>
    <div class="detail-card" role="dialog" aria-modal="true" aria-label="Import CSV">
      <div class="card" (click)="$event.stopPropagation()" style="max-width: 900px; width: 100%">
        <header class="card-header">
          <h3 class="card-title">Importa CSV</h3>
          <button type="button" class="btn-close" (click)="closeImportPrompt()" aria-label="Chiudi">
            <i class="pi pi-times"></i>
          </button>
        </header>
        <div class="card-body">
          <p class="muted">Struttura prevista (ordine colonne del CSV). Il numero indica la posizione.</p>
          <div class="field-groups" role="list">
            @for (g of requiredFieldGroups(); track g.title) {
              <section class="field-group" role="listitem" aria-label="{{ g.title }}">
                <div class="group-title">{{ g.title }}</div>
                <div class="group-fields">
                  @for (col of g.fields; track col) {
                    <span class="field-chip">
                      <span class="badge">{{ fieldIndex(col) }}</span>
                      <span class="name">{{ col }}</span>
                    </span>
                  }
                </div>
              </section>
            }
          </div>
          <div class="actions actions--equal">
            <div>
              <button class="btn" type="button" (click)="downloadTemplate()"><i class="pi pi-download" style="margin-right:6px"></i>Scarica template</button>
            </div>
            <div>
              <label class="btn primary" style="cursor: pointer; margin-right: 8px; display:inline-flex; align-items:center; justify-content:center;">
                <i class="pi pi-upload" style="margin-right:6px"></i>Scegli file CSV
                <input type="file" accept=".csv,text/csv" (change)="onCsvSelected($event)" style="display:none" />
              </label>
              <button class="btn cancel" type="button" (click)="closeImportPrompt()">Annulla</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  }
  @if (showImportPanel) {
    <div class="overlay"></div>
    <div class="detail-card" role="dialog" aria-modal="true" aria-label="Import CSV">
      <div class="card" (click)="$event.stopPropagation()" style="max-width: 900px; width: 100%">
        <header class="card-header">
          <h3 class="card-title">Importa CSV</h3>
          <button type="button" class="btn-close" (click)="cancelImport()" aria-label="Chiudi">
            <i class="pi pi-times"></i>
          </button>
        </header>
        <div class="card-body">
          <!-- Info section removed per request: show only preview table and pager -->
          <p>@if (importResult) { <span>Inseriti: {{ importResult.inserted }}, Falliti: {{ importResult.failed }}</span> }</p>
          <div class="preview-head">
            <div class="spacer"></div>
            <div class="pager">
              <button type="button" class="icon-btn" (click)="prevImport()" [disabled]="importIdx===0" title="Precedente"><i class="pi pi-angle-left"></i></button>
              <span class="pager__label">{{ importIdx + 1 }} di {{ importItems.length }}</span>
              <button type="button" class="icon-btn" (click)="nextImport()" [disabled]="importIdx+1>=importItems.length" title="Successivo"><i class="pi pi-angle-right"></i></button>
            </div>
          </div>
          <div class="import-split">
            <div class="kv-wrap">
              @if (currentPreview(); as r) {
                <div class="kv-card">
                  <div class="kv-grid">
                    @for (col of requiredFields(); track col) {
                      <div class="k">{{ col }}</div>
                      <div class="v" [class.missing]="!$any(r)[col]">{{ $any(r)[col] || '—' }}</div>
                    }
                  </div>
                </div>
              }
            </div>
            <div class="map-pane">
              @if (importMapUrl(); as mapUrl) {
                <iframe [src]="mapUrl" class="map-frame" loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Mappa posizione"></iframe>
              } @else {
                <div class="map-placeholder" style="min-height: 300px;">
                  <i class="pi pi-map-marker"></i>
                  <p>Nessuna posizione disponibile</p>
                </div>
              }
            </div>
          </div>
          <div class="import-progress" *ngIf="importInProgress">
            <div class="progress indeterminate"><div class="bar"></div></div>
            <small class="muted">Import in corso…</small>
          </div>
          <div class="actions">
            <button class="btn" type="button" (click)="cancelImport()">Annulla</button>
            <button class="btn primary" type="button" [disabled]="importInProgress || !importItems.length" (click)="confirmImport()">
              @if (importInProgress) { <span class="spinner" style="width:18px;height:18px;border-width:2px"></span> } Importa {{ importItems.length }} righe
            </button>
          </div>
        </div>
      </div>
    </div>
  }
        @if (detailOpen) {
      <div class="overlay" (click)="creating ? null : closeDetails()"></div>
      <div class="detail-card" role="dialog" aria-modal="true" [attr.aria-label]="'details.title' | t" (click)="creating ? null : closeDetails()">
        @if (detailLoading) {
          <div class="loading"><span class="spinner" role="status" aria-label="Loading"></span></div>
        } @else {
          <div class="card" (click)="$event.stopPropagation()">
            <header class="card-header">
              <h3 class="card-title">{{ 'details.title' | t }}</h3>
              <button type="button" class="btn-close" (click)="closeDetails()" [attr.aria-label]="'common.close' | t">
                <i class="pi pi-times"></i>
              </button>
            </header>
            <div class="card-body">
              <div class="detail-split">
                <div class="map-pane" aria-label="Mappa cliente">
                  @if (mapUrl) {
                    <iframe [src]="mapUrl" class="map-frame" loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Mappa posizione"></iframe>
                    <div class="coords-note" *ngIf="editing?.latitude != null && editing?.longitude != null">
                      <small>Lat: {{ editing.latitude }} | Lng: {{ editing.longitude }}</small>
                    </div>
                    <div class="map-actions">
                      <a class="link" [href]="mapsLink || '#'" target="_blank" rel="noopener">Apri in Google Maps</a>
                    </div>
                  } @else {
                    <div class="map-placeholder">
                      <i class="pi pi-map-marker"></i>
                      <p>Nessuna posizione disponibile</p>
                    </div>
                  }
                </div>
                <div class="form-pane">
              @if (showErrors && !isFormValid()) {
                <div class="form-error" role="alert" aria-live="assertive">
                  <strong>{{ 'form.fillRequired' | t }}</strong>
                  <div class="tags">
                    @for (f of missingFields(); track f) {
                      <span class="tag">{{ f }}</span>
                    }
                  </div>
                </div>
              }
                <form (submit)="saveChanges(); $event.preventDefault();">
                <div class="grid-2">
                  <label class="f-nome">
                    <span>Nome</span>
                    <input [(ngModel)]="editing.nome" name="nome" required [class.invalid]="showErrors && !(editing.nome?.trim())" />
                    @if (showErrors && !(editing.nome?.trim())) { <small class="err">Obbligatorio</small> }
                  </label>
                  <label class="f-citta">
                    <span>Città</span>
                    <input [(ngModel)]="editing.citta" name="citta" required [class.invalid]="showErrors && !(editing.citta?.trim())" />
                    @if (showErrors && !(editing.citta?.trim())) { <small class="err">Obbligatorio</small> }
                  </label>
                  <label class="f-categoria">
                    <span>Categoria</span>
                    <input [(ngModel)]="editing.categoria" name="categoria" required [class.invalid]="showErrors && !(editing.categoria?.trim())" />
                    @if (showErrors && !(editing.categoria?.trim())) { <small class="err">Obbligatorio</small> }
                  </label>
                  <label class="f-assegnato">
                    <span>Assegnato</span>
                    <select [(ngModel)]="editing.assegnato" name="assegnato">
                      <option [ngValue]="null">-- Nessuno --</option>
                      @for (u of users; track u.id) {
                        <option [ngValue]="u.username">{{ u.display }}</option>
                      }
                    </select>
                    
                  </label>
                  <label class="f-stato">
                    <span>Status</span>
                    <select [(ngModel)]="editing.stato" name="stato" required [class.invalid]="showErrors && !(editing.stato?.trim())">
                      <option [ngValue]="null" disabled hidden>-- Seleziona --</option>
                      @for (s of states; track s) {
                        <option [ngValue]="s">{{ s }}</option>
                      }
                    </select>
                    @if (showErrors && !(editing.stato?.trim())) { <small class="err">{{ 'form.required' | t }}</small> }
                  </label>
                  <label class="f-fu1">
                    <span>{{ 'form.follow1' | t }}</span>
                    <input [(ngModel)]="editing.data_follow_up_1" name="data_follow_up_1" type="date" />
                  </label>
                  <label class="f-fu2">
                    <span>{{ 'form.follow2' | t }}</span>
                    <input [(ngModel)]="editing.data_follow_up_2" name="data_follow_up_2" type="date" />
                  </label>
                  <label class="f-sito">
                    <span>{{ 'form.site' | t }}</span>
                    <input [(ngModel)]="editing.site" name="site" />
                  </label>
                  <label class="f-email">
                    <span>{{ 'form.email' | t }}</span>
                    <input [(ngModel)]="editing.email_1" name="email_1" type="email" />
                  </label>
                  <label class="f-telefono">
                    <span>{{ 'form.phone' | t }}</span>
                    <input [(ngModel)]="editing.phone_1" name="phone_1" />
                    </label>

                  <label class="span-2">
                    <button type="button" class="link" (click)="showMoreContacts = !showMoreContacts">
                      <i class="pi" [ngClass]="showMoreContacts ? 'pi-angle-down' : 'pi-angle-right'"></i>
                      <span>{{ 'form.moreContacts' | t }}</span>
                    </button>
                  </label>

                  @if (showMoreContacts) {
                    <!-- Row 1: Email 2 | Telefono 2 -->
                    <label>
                      <span>{{ 'form.email2' | t }}</span>
                      <input [(ngModel)]="editing.email_2" name="email_2" type="email" />
                    </label>
                    <label>
                      <span>{{ 'form.phone2' | t }}</span>
                      <input [(ngModel)]="editing.phone_2" name="phone_2" />
                    </label>
                    <!-- Row 2: Email 3 | Telefono 3 -->
                    <label>
                      <span>{{ 'form.email3' | t }}</span>
                      <input [(ngModel)]="editing.email_3" name="email_3" type="email" />
                    </label>
                    <label>
                      <span>{{ 'form.phone3' | t }}</span>
                      <input [(ngModel)]="editing.phone_3" name="phone_3" />
                    </label>
                    <!-- Row 3: Latitudine | Longitudine -->
                    <label>
                      <span>{{ 'form.latitude' | t }}</span>
                      <input [(ngModel)]="editing.latitude" name="latitude" type="number" step="0.000001" (input)="onCoordChange()" />
                    </label>
                    <label>
                      <span>{{ 'form.longitude' | t }}</span>
                      <input [(ngModel)]="editing.longitude" name="longitude" type="number" step="0.000001" (input)="onCoordChange()" />
                    </label>
                  }
                  <label class="span-2">
                    <span>{{ 'form.notes' | t }}</span>
                    <textarea [(ngModel)]="editing.note" name="note" rows="3"></textarea>
                  </label>
                </div>
                <div class="actions">
                  <button type="button" class="btn primary" (click)="openSaveConfirm()" [disabled]="saving">{{ 'common.save' | t }}</button>
                  
                </div>
                </form>
                </div> <!-- /.form-pane -->
              </div> <!-- /.detail-split -->
            </div>
        </div>
      }
    </div>
  }

  @if (confirmDelete) {
    <div class="overlay overlay--confirm" (click)="closeConfirmDelete()"></div>
    <div class="confirm-card" role="dialog" aria-modal="true" [attr.aria-label]="'confirm.delete.title' | t">
      <div class="card">
        <header class="card-header">
          <h3 class="card-title">{{ 'confirm.delete.title' | t }}</h3>
          <button type="button" class="btn-close" (click)="closeConfirmDelete()" [attr.aria-label]="'common.close' | t">
            <i class="pi pi-times"></i>
          </button>
        </header>
        <div class="card-body">
          <p>{{ 'confirm.delete.warning' | t }}</p>
          <div class="actions">
            <button type="button" class="btn ghost" (click)="closeConfirmDelete()">{{ 'common.cancel' | t }}</button>
            <button type="button" class="btn danger" (click)="deleteCliente()" [disabled]="deleting">{{ 'common.delete' | t }}</button>
          </div>
        </div>
      </div>
    </div>
  }

  @if (confirmSite) {
    <div class="overlay overlay--confirm" (click)="closeSiteConfirm()"></div>
    <div class="confirm-card" role="dialog" aria-modal="true" [attr.aria-label]="'confirm.site.title' | t">
      <div class="card">
        <header class="card-header">
          <h3 class="card-title">{{ 'confirm.site.title' | t }}</h3>
          <button type="button" class="btn-close" (click)="closeSiteConfirm()" [attr.aria-label]="'common.close' | t">
            <i class="pi pi-times"></i>
          </button>
        </header>
        <div class="card-body">
          <p>{{ 'confirm.site.opening' | t }}</p>
          <p><strong>{{ pendingSiteUrl }}</strong></p>
          <div class="actions">
            <button type="button" class="btn ghost" (click)="closeSiteConfirm()">{{ 'common.cancel' | t }}</button>
            <button type="button" class="btn primary" (click)="proceedOpenSite()">{{ 'common.proceed' | t }}</button>
          </div>
        </div>
      </div>
    </div>
  }

  @if (confirmSave) {
    <div class="overlay overlay--confirm" (click)="closeSaveConfirm()"></div>
    <div class="confirm-card" role="dialog" aria-modal="true" [attr.aria-label]="'confirm.save.title' | t">
      <div class="card">
        <header class="card-header">
          <h3 class="card-title">{{ 'confirm.save.title' | t }}</h3>
          <button type="button" class="btn-close" (click)="closeSaveConfirm()" [attr.aria-label]="'common.close' | t">
            <i class="pi pi-times"></i>
          </button>
        </header>
        <div class="card-body">
          @if (changesSummary.length === 0) {
            <p>{{ 'confirm.save.noChanges' | t }}</p>
          } @else {
            <ul>
              @for (ch of changesSummary; track ch.key) {
                <li><strong>{{ ch.label | t }}:</strong> {{ ch.from }} → {{ ch.to }}</li>
              }
            </ul>
          }
          <div class="actions">
            <button type="button" class="btn ghost" (click)="closeSaveConfirm()">{{ 'common.cancel' | t }}</button>
            <button type="button" class="btn primary" (click)="saveChanges()" [disabled]="saving">{{ 'common.confirm' | t }}</button>
          </div>
        </div>
      </div>
    </div>
  }
  </section>

