<h2 class="page__title">Scraper</h2>

<div *ngIf="!canUseScraper" class="empty-state">
  <div class="empty-icon"><i class="pi pi-lock"></i></div>
  <h3 class="empty-title">Scraper disabilitato</h3>
  <p class="empty-desc">Per usare lo Scraper salva una Google Places API key nelle impostazioni utente.</p>
  <a class="btn primary" routerLink="/profilo"><i class="pi pi-cog"></i>Vai alle impostazioni</a>
  <p class="empty-hint">Dopo il salvataggio, torna qui: la pagina si abiliterà automaticamente.</p>
</div>

<div class="toolbar" *ngIf="canUseScraper">
  <button class="text-btn action-add" type="button" (click)="openNew()">
    <i class="pi pi-plus"></i>
    <span>Nuova estrazione</span>
  </button>
  </div>

<div class="cards-w" *ngIf="canUseScraper">
    <div class="card job" *ngFor="let j of jobs">
      <div class="job-header" (click)="openJob(j)">
        <div class="job-main">
          <div class="job-title">{{ j.name || j.params?.query || '(senza nome)' }}</div>
          <div class="job-sub">Lat: {{ j.params?.lat }} · Lng: {{ j.params?.lng }} · Raggio: {{ j.params?.radius_m }}m</div>
        </div>
        <div class="job-meta">
          <span class="badge" [ngClass]="j.status">{{ j.status }}</span>
          <span class="when">{{ j.created_at | date:'short' }}</span>
          <span class="when">Test</span>
        </div>
      </div>
      <div class="accordion-body" *ngIf="jobId === j.id">
        <hr class="divider" />
        <div class="status">
          <p>Job: <code>{{ j.id }}</code></p>
          <p>Stato: <strong>{{ j.status }}</strong> — Progresso: {{ j.progress }}%</p>
          <div class="after">
            <div class="actions">
              <button class="btn primary" type="button" (click)="doImportFor(j.id)" [disabled]="importingById[j.id]">{{ importingById[j.id] ? 'Import in corso...' : 'Importa nella lista contatti' }}</button>
              <a class="btn" [href]="exportingCsvUrl(j.id)" target="_blank" rel="noopener"><i class="pi pi-download" style="margin-right:6px"></i>Esporta CSV</a>
              <a class="btn" [href]="exportingJsonUrl(j.id)" target="_blank" rel="noopener">Esporta JSON</a>
              <button class="btn" type="button" (click)="openFullPreview(j.id)"><i class="pi pi-eye" style="margin-right:6px"></i>Anteprima completa</button>
            </div>
            <div *ngIf="importResultById[j.id]" class="flash success" style="margin-top:12px;">Importati {{ importResultById[j.id]?.inserted }} di {{ importResultById[j.id]?.total }} contatti.</div>
            <div class="muted small" style="margin-top:8px;">Usa "Anteprima completa" per visualizzare i risultati dell'estrazione.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="muted" *ngIf="!jobs?.length">Nessuna estrazione trovata. Crea la prima con "Nuova estrazione".</div>
</div>

<!-- Nuova griglia card jobs (centrata, responsive) -->
<div class="jobs-grid" *ngIf="canUseScraper">
  <div class="card job" *ngFor="let j of jobs" [class.open]="jobId === j.id">
    <div class="job-head" (click)="openJob(j)">
      <div class="job-title">{{ j.name || j.params?.query || '(senza nome)' }} <span class="job-sub">— {{ j.created_at | date:'short' }}</span></div>
      <span class="badge" [ngClass]="j.status">{{ j.status }}</span>
    </div>
    <div class="job-body" *ngIf="jobId === j.id">
      <div class="job-progress-row">
        <div></div>
        <div class="job-progress">Progresso: {{ j.progress }}%</div>
      </div>
      <div class="job-row">
        <div class="job-id">Job: <code>{{ j.id }}</code></div>
        <div></div>
      </div>
      <div class="job-row">
        <div><button class="btn" type="button" (click)="exportCsv(j.id)"><i class="pi pi-download" style="margin-right:6px"></i>Esporta CSV</button></div>
        <div><button class="btn" type="button" (click)="openFullPreview(j.id)"><i class="pi pi-eye" style="margin-right:6px"></i>Anteprima e importa</button></div>
      </div>
      <div *ngIf="importResultById[j.id]" class="flash success" style="margin-top:8px;">Importati {{ importResultById[j.id]?.inserted }} di {{ importResultById[j.id]?.total }} contatti.</div>
    </div>
  </div>
  <div class="muted" *ngIf="!jobs?.length">Nessuna estrazione trovata. Crea la prima con "Nuova estrazione".</div>
</div>

<!-- Confirm Import modal -->
<div class="overlay overlay--confirm" *ngIf="showConfirmImport" (click)="closeConfirmImport()"></div>
<div class="confirm-card" *ngIf="showConfirmImport" role="dialog" aria-modal="true" aria-label="Conferma import" (click)="$event.stopPropagation()">
  <div class="card">
    <header class="card-header">
      <h3 class="card-title">Confermi importazione contatti?</h3>
      <button type="button" class="btn-close" (click)="closeConfirmImport()" aria-label="Chiudi">
        <i class="pi pi-times"></i>
      </button>
    </header>
    <div class="card-body">
      <p>Questa operazione creerà nuovi contatti nella lista Clienti.</p>
      <p *ngIf="pendingImportCount != null && pendingImportCount >= 0" class="muted">Righe da importare: <strong>{{ pendingImportCount }}</strong></p>
      <div class="actions actions--confirm">
        <button type="button" class="btn" (click)="closeConfirmImport()">Annulla</button>
        <button type="button" class="btn primary" (click)="proceedConfirmImport()">Importa</button>
      </div>
    </div>
  </div>
  
</div>

<!-- Modal anteprima completa (stile come Import CSV) -->
<div class="overlay" *ngIf="showPreviewModal" (click)="closeFullPreview()"></div>
<div class="detail-card" *ngIf="showPreviewModal" role="dialog" aria-modal="true" aria-label="Anteprima risultati" (click)="$event.stopPropagation()">
  <div class="card" style="max-width: 900px; width: 100%">
    <header class="card-header">
      <h3 class="card-title">Anteprima risultati</h3>
      <button type="button" class="btn-close" (click)="closeFullPreview()" aria-label="Chiudi"><i class="pi pi-times"></i></button>
    </header>
    <div class="card-body">
      <div class="preview-head">
        <div class="spacer"></div>
        <div class="pager">
          <button type="button" class="icon-btn" (click)="prevPreviewItem()" [disabled]="previewIdx===0" title="Precedente"><i class="pi pi-angle-left"></i></button>
          <span class="pager__label">{{ previewIdx + 1 }} di {{ previewItems.length }}</span>
          <button type="button" class="icon-btn" (click)="nextPreviewItem()" [disabled]="previewIdx+1>=previewItems.length" title="Successivo"><i class="pi pi-angle-right"></i></button>
        </div>
      </div>
      <div class="import-split">
        <div class="kv-wrap">
          @if (previewCurrent(); as r) {
            <div class="kv-card">
              <div class="kv-grid">
                @for (col of previewRequiredFields(); track col) {
                  <div class="k">{{ col }}</div>
                  <div class="v" [class.missing]="!$any(r)[col]">{{ $any(r)[col] || '—' }}</div>
                }
              </div>
            </div>
          }
        </div>
        <div class="map-pane">
          @if (previewMapUrl(); as mapUrl) {
            <iframe [src]="mapUrl" class="map-frame" loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Mappa posizione"></iframe>
          } @else {
            <div class="map-placeholder" style="min-height: 300px;">
              <i class="pi pi-map-marker"></i>
              <p>Nessuna posizione disponibile</p>
            </div>
          }
        </div>
      </div>
      <div class="actions actions--preview">
        <button type="button" class="btn" (click)="closeFullPreview()">Annulla</button>
        <button type="button" class="btn primary" (click)="previewJobId && openConfirmImport(previewJobId)" [disabled]="!previewJobId || importingById[previewJobId]">Importa</button>
      </div>
    </div>
  </div>
  
</div>
<!-- Modal nuova estrazione -->
<div class="overlay" *ngIf="showNewModal" (click)="closeNew()"></div>
<div class="detail-card" *ngIf="showNewModal" role="dialog" aria-modal="true" aria-label="Nuova estrazione" (click)="$event.stopPropagation()">
  <div class="card" style="max-width: 900px; width: 100%">
    <header class="card-header">
      <h3 class="card-title">Nuova estrazione</h3>
      <button type="button" class="btn-close" (click)="closeNew()" aria-label="Chiudi"><i class="pi pi-times"></i></button>
    </header>
    <div class="card-body">
      <form (submit)="$event.preventDefault(); submit();">
        <div class="new-extract-grid">
          <div class="map-wrap">
            <div id="newJobMap" class="map" aria-label="Mappa selezione coordinate"></div>
          </div>
          <div>
            <div class="fields-vertical">
              <label>
                <span>Nome job (opzionale)</span>
                <input type="text" [(ngModel)]="newName" name="name" placeholder="es. Bari ristoranti ottobre" />
              </label>
              <label>
                <span>Query</span>
                <input type="text" [(ngModel)]="query" name="query" placeholder="es. ristoranti">
              </label>
              <label>
                <span>Lat</span>
                <input type="number" step="0.000001" [(ngModel)]="lat" name="lat" (ngModelChange)="onCoordChange()">
              </label>
              <label>
                <span>Lng</span>
                <input type="number" step="0.000001" [(ngModel)]="lng" name="lng" (ngModelChange)="onCoordChange()">
              </label>
              <label>
                <span>Raggio (m)</span>
                <input type="number" [(ngModel)]="radius_m" name="radius_m">
              </label>
              <label>
                <span>Limite</span>
                <input type="number" [(ngModel)]="limit" name="limit">
              </label>
            </div>
            <p class="muted small">Clicca sulla mappa per impostare Lat/Lng</p>
            <p class="muted small">Fonte dati: Google Places API</p>
          </div>
        </div>
        <div class="actions" style="justify-content: flex-end; margin-top: .75rem;">
          <button class="btn" type="button" (click)="closeNew()">Annulla</button>
          <button class="btn primary" type="submit" [disabled]="creating">{{ creating ? 'Creazione...' : 'Crea job' }}</button>
        </div>
      </form>
    </div>
  </div>
</div>
